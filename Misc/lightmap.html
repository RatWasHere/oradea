<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <style>
    :root {
      --tunnel-size: 100px;
      --ring-inner: 30%;
      --ring-outer: 70%;
      --arc-start: 10deg;
      --arc-angle: 60deg;
      /* NEW: arc size */
      --arc-end: calc(var(--arc-start) + var(--arc-angle));
      --ring-color: cyan;
    }

    .viewport {
      perspective: 800px;
      /* Controls the strength of the 3D effect */
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: black;
      position: relative;
    }

    .tunnel-item {
      width: var(--tunnel-size);
      height: var(--tunnel-size);
      background:
        radial-gradient(circle, transparent var(--ring-inner), var(--ring-color) calc(var(--ring-inner) + 1%), var(--ring-color) var(--ring-outer), transparent calc(var(--ring-outer) + 1%));
      position: absolute;
      top: 50%;
      left: 50%;
      border-radius: 50%;
      transform-style: preserve-3d;
      animation: tunnelMove 3s linear infinite;
      -webkit-mask-image: conic-gradient(transparent 0deg var(--arc-start), white var(--arc-start) var(--arc-end), transparent var(--arc-end) 360deg);
      mask-image: conic-gradient(transparent 0deg var(--arc-start), white var(--arc-start) var(--arc-end), transparent var(--arc-end) 360deg);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
    }

    @keyframes war {
      0% {
        rotate: 0deg;
      }

      100% {
        rotate: -360deg;
      }
    }

    @keyframes tunnelMove {
      0% {
        transform: translate(-50%, -50%) translateZ(-1000px) scale(0.8);
        opacity: 0;
      }

      50% {
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) translateZ(0px) scale(1.5);
        opacity: 0;
      }
    }
  </style>
</head>

<body>

  <a href="../Picker/LevelPicker.html">back</a>
  <a href="./waccastyle.html">wacca</a>
</body>
<script>
  let parser = require('osu-mania-parser');
  let beatmap = parser.parseFileSync('./Misc/lightmap.osu');
  let sheet = [];
  function swap(json) {
    var ret = {};
    for (var key in json) {
      ret[json[key]] = key;
    }
    return ret;
  }


  let unprocessedSheet = {};

  let keyPositions = swap(beatmap.keyPositions);

  function getEasing(effect) {
    if (effect.hitSound.includes('whistle') && effect.hitSound.includes('clap')) {
      return 'ease-in-out'
    } else if (effect.hitSound.includes('whistle')) {
      return 'ease-in'
    } else if (effect.hitSound.includes('clap')) {
      return 'ease-out'
    } else return 'ease'
  }

  function createTransition(effect, property) {
    if (effect.type == "note") {
      return `${property} 0s linear`
    } else {
      return `${property} ${effect.endTime - effect.time}ms ${getEasing(effect)}`
    }
  }

  function getIntensity(effect, regular, alternative) {
    if (effect.hitSound.includes('finish') && effect.hitSound.includes('clap') && effect.hitSound.includes('whistle')) return null;
    if (!effect.hitSound.includes('finish')) { return regular } else return alternative;
  }

  beatmap.hitObjects.forEach((effect, index) => {
    let effectType = Number(keyPositions[effect.x]) + 1;
    let effects = {};
    let transitions = {};

    if (effectType == 0) { // rotate negative degrees
      transitions['rotate'] = createTransition(effect, 'rotate')
      effects['rotate'] = getIntensity(effect, '-10deg', '-30deg')
    } else if (effectType == 1) {
      transitions['transform'] = createTransition(effect, 'transform')
      effects['transform'] = getIntensity(effect, 'translateX(-10px)', 'translateX(-30px)')
    } else if (effectType == 2) {
      transitions['transform'] = createTransition(effect, 'transform')
      effects['transform'] = getIntensity(effect, 'translateY(-10px)', 'translateY(-30px)')
    } else if (effectType == 3) {
      transitions['scale'] = createTransition(effect, 'scale')
      effects['scale'] = getIntensity(effect, '1.07', '1.15')
    } else if (effectType == 4) {
      transitions['scale'] = createTransition(effect, 'scale')
      effects['scale'] = getIntensity(effect, '0.95', '0.85')
    } else if (effectType == 5) {
      transitions['transform'] = createTransition(effect, 'transform')
      effects['transform'] = getIntensity(effect, 'translateY(10px)', 'translateY(30px)')
    } else if (effectType == 6) {
      transitions['transform'] = createTransition(effect, 'transform')
      effects['transform'] = getIntensity(effect, 'translateX(10px)', 'translateX(30px)')
    } else if (effectType == 7) {
      transitions['rotate'] = createTransition(effect, 'rotate')
      effects['rotate'] = getIntensity(effect, '-10deg', '-30deg')
    } else if (effectType == 8) {
      transitions['filter'] = createTransition(effect, 'filter')
      effects['filter'] = getIntensity(effect, 'blur(3px)', 'blur(5px)')
    }

    if (!unprocessedSheet[effect.time]) {
      unprocessedSheet[effect.time] = {
        transitions: []
      }
    }
    unprocessedSheet[effect.time] = {...unprocessedSheet[effect.time], ...effects};
    unprocessedSheet[effect.time].transitions.push(transitions[Object.keys(transitions)[0]])
  });

  let finalSheet = [];
  
  for (let i in unprocessedSheet) {
    finalSheet.push({
      time: Number(i),
      playfield: {
        transition: unprocessedSheet[i].transitions.join(', '),
        ...unprocessedSheet[i]
      }
    })
  }


  require('fs').writeFileSync('./Misc/lightmap.json', JSON.stringify(finalSheet, null, 2));

</script>

</html>